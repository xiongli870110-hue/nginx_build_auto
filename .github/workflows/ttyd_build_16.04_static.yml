name: Build ttyd and Release Static

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-ttyd:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Build static ttyd inside Ubuntu 16.04 container
      run: |
        docker run --rm -v $PWD:/build -w /build ubuntu:16.04 bash -c "
          set -e
          apt update &&
          DEBIAN_FRONTEND=noninteractive apt install -y \
            build-essential \
            git \
            curl ca-certificates \
            zlib1g-dev \
            libuv1-dev \
            pkg-config &&

          # 安装 CMake 3.27.9
          curl -LO https://github.com/Kitware/CMake/releases/download/v3.27.9/cmake-3.27.9-linux-x86_64.tar.gz &&
          tar -xzf cmake-3.27.9-linux-x86_64.tar.gz &&
          mv cmake-3.27.9-linux-x86_64 /opt/cmake &&
          ln -s /opt/cmake/bin/cmake /usr/local/bin/cmake &&
          export PATH=/opt/cmake/bin:\$PATH &&
          cmake --version &&

          # 构建 OpenSSL 静态库
          curl -LO https://www.openssl.org/source/openssl-1.1.1u.tar.gz &&
          tar -xzf openssl-1.1.1u.tar.gz &&
          cd openssl-1.1.1u &&
          ./config --prefix=/opt/openssl no-shared &&
          make -j\$(nproc) &&
          make install &&
          cd /build &&

          # 构建 json-c 静态库
          curl -LO https://s3.amazonaws.com/json-c_releases/releases/json-c-0.17.tar.gz &&
          tar -xzf json-c-0.17.tar.gz &&
          cd json-c-0.17 &&
          mkdir build && cd build &&
          cmake .. -DCMAKE_INSTALL_PREFIX=/opt/json-c -DBUILD_SHARED_LIBS=OFF &&
          make -j\$(nproc) &&
          make install &&
          cd /build &&

          # 构建 libwebsockets 静态库
          git clone https://github.com/warmcat/libwebsockets.git -b v4.3.2 &&
          cd libwebsockets &&
          mkdir build && cd build &&
          cmake .. -DCMAKE_INSTALL_PREFIX=/opt/libwebsockets \
                   -DLWS_WITH_STATIC=ON \
                   -DLWS_WITH_SHARED=OFF \
                   -DLWS_WITH_SSL=ON \
                   -DLWS_WITH_LIBUV=ON \
                   -DOPENSSL_ROOT_DIR=/opt/openssl \
                   -DOPENSSL_INCLUDE_DIR=/opt/openssl/include \
                   -DOPENSSL_CRYPTO_LIBRARY=/opt/openssl/lib/libcrypto.a &&
          make -j\$(nproc) &&
          make install &&
          cd /build &&

          # 构建 ttyd 静态版本
          git clone https://github.com/tsl0922/ttyd.git &&
          cd ttyd &&
          mkdir build && cd build &&
          cmake .. -DCMAKE_INSTALL_PREFIX=/opt/ttyd \
                   -DLibwebsockets_DIR=/opt/libwebsockets/lib/cmake/libwebsockets \
                   -DOPENSSL_ROOT_DIR=/opt/openssl \
                   -DJSONC_LIBRARY=/opt/json-c/lib/libjson-c.a \
                   -DJSONC_INCLUDE_DIR=/opt/json-c/include/json-c \
                   -DZLIB_LIBRARY=/usr/lib/x86_64-linux-gnu/libz.a \
                   -DZLIB_INCLUDE_DIR=/usr/include \
                   -DCMAKE_EXE_LINKER_FLAGS='-static' \
                   -DCMAKE_FIND_LIBRARY_SUFFIXES='.a' \
                   -DCMAKE_SKIP_RPATH=ON &&
          make -j\$(nproc) &&
          make install &&

          mkdir -p /build/output &&
          cp /opt/ttyd/bin/ttyd /build/output/ttyd
        "

    - name: Package build output
      run: |
        tar -czvf ttyd-build.tar.gz output

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ttyd-1.7.7-static
        name: "ttyd 1.7.7 Static Build"
        body: |
          ✅ Built inside Ubuntu 16.04 container (glibc 2.23)  
          ✅ Fully statically linked — no runtime dependency on libwebsockets, libuv, OpenSSL, json-c, or zlib  
          ✅ Compatible with QNAP NAS, Alpine, BusyBox, and other minimal systems  
          ✅ libuv support enabled, mbedtls disabled  
          ✅ OpenSSL 1.1.1u + libwebsockets 4.3.2 + json-c 0.17
        files: ttyd-build.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GH_PAT }}
