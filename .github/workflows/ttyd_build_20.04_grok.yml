name: Build ttyd and Release Ubuntu_2004

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-ttyd:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Build ttyd (fully static) inside Ubuntu 20.04 container
        run: |
          docker run --rm -v $PWD:/build -w /build ubuntu:20.04 bash -c "
            set -e

            # ---------- åŸºç¡€å·¥å…· ----------
            apt update
            DEBIAN_FRONTEND=noninteractive apt install -y \
              build-essential cmake git wget tar \
              autoconf libtool pkg-config perl

            # ---------- æ¸…ç†æ—§ç›®å½• ----------
            rm -rf json-c-* libev-* libwebsockets-* ttyd zlib-* libuv* openssl-* *.tar.gz

            # ---------- 1. é™æ€ç¼–è¯‘ zlib ----------
            wget -q https://github.com/madler/zlib/releases/download/v1.2.13/zlib-1.2.13.tar.gz
            tar -xzf zlib-1.2.13.tar.gz
            cd zlib-1.2.13
            ./configure --static --prefix=/usr/local
            make -j\$(nproc) && make install
            cd ..

            # ---------- 2. é™æ€ç¼–è¯‘ OpenSSL ----------
            wget -q https://www.openssl.org/source/openssl-1.1.1w.tar.gz
            tar -xzf openssl-1.1.1w.tar.gz
            cd openssl-1.1.1w
            ./Configure linux-x86_64 no-shared --prefix=/usr/local
            make -j\$(nproc) && make install
            cd ..

            # ---------- 3. é™æ€ç¼–è¯‘ libjson-c ----------
            wget -q https://github.com/json-c/json-c/archive/json-c-0.15-20200726.tar.gz
            tar -xzf json-c-0.15-20200726.tar.gz
            cd json-c-json-c-0.15-20200726
            mkdir build && cd build
            cmake .. -DBUILD_SHARED_LIBS=OFF -DCMAKE_INSTALL_PREFIX=/usr/local
            make -j\$(nproc) && make install
            cd ../..

            # ---------- 4. é™æ€ç¼–è¯‘ libev ----------
            wget -q http://dist.schmorp.de/libev/Attic/libev-4.33.tar.gz
            tar -xzf libev-4.33.tar.gz
            cd libev-4.33
            ./configure --disable-shared --prefix=/usr/local
            make -j\$(nproc) && make install
            cd ..

            # ---------- 5. é™æ€ç¼–è¯‘ libuv ----------
            git clone https://github.com/libuv/libuv.git
            cd libuv
            sh autogen.sh
            ./configure --disable-shared --enable-static --prefix=/usr/local
            make -j\$(nproc) && make install
            cd ..

            # ---------- 6. é™æ€ç¼–è¯‘ libwebsockets ----------
            wget -q https://github.com/warmcat/libwebsockets/archive/v4.3.2.tar.gz -O lws.tar.gz
            tar -xzf lws.tar.gz
            cd libwebsockets-4.3.2
            mkdir build && cd build
            cmake .. \
              -DLWS_WITH_SHARED=OFF \
              -DLWS_WITH_SSL=ON \
              -DLWS_WITH_LIBUV=ON \
              -DLWS_WITHOUT_TESTAPPS=ON \
              -DCMAKE_INSTALL_PREFIX=/usr/local
            make -j\$(nproc) && make install
            cd ../..

            # ---------- 7. ç¼–è¯‘ ttydï¼ˆçœŸæ­£é™æ€é“¾æ¥ï¼‰ ----------
            git clone https://github.com/tsl0922/ttyd.git
            cd ttyd
            mkdir build && cd build
            cmake .. \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_INSTALL_PREFIX=/opt/ttyd \
              -DLIBWEBSOCKETS_LIBRARIES=/usr/local/lib/libwebsockets.a \
              -DLIBWEBSOCKETS_INCLUDE_DIR=/usr/local/include \
              -DJSONC_LIBRARIES=/usr/local/lib/libjson-c.a \
              -DJSONC_INCLUDE_DIR=/usr/local/include/json-c \
              -DLIBEV_LIBRARIES=/usr/local/lib/libev.a \
              -DLIBEV_INCLUDE_DIR=/usr/local/include \
              -DLIBUV_LIBRARIES=/usr/local/lib/libuv.a \
              -DLIBUV_INCLUDE_DIR=/usr/local/include \
              -DZLIB_LIBRARY=/usr/local/lib/libz.a \
              -DZLIB_INCLUDE_DIR=/usr/local/include \
              -DOPENSSL_ROOT_DIR=/usr/local \
              -DOPENSSL_LIBRARIES='/usr/local/lib/libssl.a;/usr/local/lib/libcrypto.a' \
              -DOPENSSL_INCLUDE_DIR=/usr/local/include \
              -DBUILD_SHARED_LIBS=OFF \
              -DCMAKE_EXE_LINKER_FLAGS='-static' \
              -DCMAKE_FIND_LIBRARY_SUFFIXES=.a \
              -DCMAKE_IGNORE_PATH=/usr/lib/x86_64-linux-gnu;/lib/x86_64-linux-gnu
            make -j\$(nproc)
            make install

            # ---------- 8. æ‰“åŒ… ----------
            mkdir -p /build/output
            cp /opt/ttyd/bin/ttyd /build/output/ttyd
          "

      - name: Verify static linking
        run: |
          echo "ğŸ” file output/ttyd:"
          file output/ttyd
          echo "ğŸ” ldd output/ttyd:"
          ldd output/ttyd || echo 'âœ… Static linkage confirmed: no dynamic dependencies'

      - name: Package build output
        run: |
          tar -czvf ttyd-build.tar.gz output

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ttyd-1.7.4-grok
          name: "ttyd 1.7.4 Grok Static Build"
          body: |
            âœ… Built inside Ubuntu 20.04 container (glibc 2.31)  
            âœ… Fully statically linked: OpenSSL, zlib, libjson-c, libev, libwebsockets, libuv  
            âœ… Compatible with QNAP NAS, Debian 10+, Ubuntu 20.04/22.04/24.04, Alpine, BusyBox  
            âœ… No runtime dependencies â€” verified with ldd  
            âš ï¸ Not compatible with glibc < 2.25
          files: ttyd-build.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
