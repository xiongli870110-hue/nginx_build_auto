name: Build ttyd and Release Ubuntu_2004
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-ttyd:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Build ttyd (static) inside Ubuntu 20.04 container
        run: |
          docker run --rm -v $PWD:/build -w /build ubuntu:20.04 bash -c "
            set -e

            # ---------- 基础工具 ----------
            apt update
            DEBIAN_FRONTEND=noninteractive apt install -y \
              build-essential cmake git wget tar \
              libssl-dev zlib1g-dev libpam0g-dev

            # ---------- 1. 静态编译 libjson-c ----------
            wget -q https://github.com/json-c/json-c/archive/json-c-0.15-20200726.tar.gz
            tar -xzf json-c-0.15-20200726.tar.gz
            cd json-c-json-c-0.15-20200726
            mkdir build && cd build
            cmake .. -DBUILD_SHARED_LIBS=OFF -DCMAKE_INSTALL_PREFIX=/usr/local
            make -j\$(nproc) && make install
            cd ../..

            # ---------- 2. 静态编译 libev ----------
            wget -q http://dist.schmorp.de/libev/Attic/libev-4.33.tar.gz
            tar -xzf libev-4.33.tar.gz
            cd libev-4.33
            ./configure --disable-shared --prefix=/usr/local
            make -j\$(nproc) && make install
            cd ..

            # ---------- 3. 静态编译 libwebsockets ----------
            wget -q https://github.com/warmcat/libwebsockets/archive/v4.3.2.tar.gz -O lws.tar.gz
            tar -xzf lws.tar.gz
            cd libwebsockets-4.3.2
            mkdir build && cd build
            cmake .. \
              -DLWS_WITH_SHARED=OFF \
              -DLWS_WITH_SSL=ON \
              -DLWS_WITHOUT_TESTAPPS=ON \
              -DCMAKE_INSTALL_PREFIX=/usr/local
            make -j\$(nproc) && make install
            cd ../..

            # ---------- 4. 编译 ttyd（静态链接） ----------
            git clone https://github.com/tsl0922/ttyd.git
            cd ttyd
            mkdir build && cd build
            cmake .. \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_INSTALL_PREFIX=/opt/ttyd \
              -DLIBWEBSOCKETS_INCLUDE_DIR=/usr/local/include \
              -DLIBWEBSOCKETS_LIBRARIES=/usr/local/lib/libwebsockets.a \
              -DJSONC_INCLUDE_DIR=/usr/local/include/json-c \
              -DJSONC_LIBRARIES=/usr/local/lib/libjson-c.a \
              -DLIBEV_INCLUDE_DIR=/usr/local/include \
              -DLIBEV_LIBRARIES=/usr/local/lib/libev.a
            make -j\$(nproc)
            make install

            # ---------- 5. 打包 ----------
            mkdir -p /build/output
            cp /opt/ttyd/bin/ttyd /build/output/ttyd
          "

      - name: Verify static linking
        run: |
          file output/ttyd
          ldd output/ttyd | grep -i "not a dynamic executable" && echo "Static linking: SUCCESS"

      - name: Package build output
        run: |
          tar -czvf ttyd-build.tar.gz output

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ttyd-1.7.4-grok
          name: "ttyd 1.7.4 Grok Static Build"
          body: |
            Built inside **Ubuntu 20.04** container (glibc 2.31)  
            **完全静态链接** `libjson-c`、`libev`、`libwebsockets`  
            兼容 Debian 10+、Ubuntu 20.04/22.04/24.04、QNAP NAS 等  
            **无任何动态库依赖**  
            Not compatible with glibc < 2.25
          files: ttyd-build.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
